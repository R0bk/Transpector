(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5405],{48312:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return n(58722)}])},58722:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return eH}});var a=n(41844),l=n(55784),o=n(69071),s=n(32871),r=n(83599);n(92450);var d=n(76248),i=n(73445),c=n(73073);let u=[{id:"text",type:"textInput",data:{text:"Jane Doe"},position:{x:-200,y:400}},{id:"tokenizedWords",type:"tokenizedWords",data:{tokenizedWords:[["This","is","an","ex","amp","le"]],pattern:c.nGf([1,12,7,7])},position:{x:-200,y:300}},{id:"tokens",type:"token",data:{tokens:[1,2,3,4,5]},position:{x:-200,y:200}},{id:"we",type:"embed",data:{label:"Textual Embedding",realationId:"hook_embed",embed:c.nGf([1,5,5])},position:{x:-200,y:-200}},{id:"pos",type:"embed",data:{label:"Positional Embedding",realationId:"hook_pos_embed",embed:c.nGf([1,5,5])},position:{x:200,y:-200}}],p=[{id:"e1",source:"text",target:"tokenizedWords"},{id:"e2",source:"tokenizedWords",target:"tokens"},{id:"e3",source:"tokens",target:"we",type:"button"},{id:"e4",source:"tokens",target:"pos",type:"button"},{id:"we-b1",source:"we",target:"blocks.0"},{id:"e8",source:"we",target:"blocks.0.hook_resid_mid"},{id:"e9",source:"pos",target:"blocks.0"},{id:"e12",source:"pos",target:"blocks.0.hook_resid_mid"}],m=(e,t)=>{let{[e]:n,...a}=t;return a},x={method:"PUT",headers:{"Content-Type":"application/json"}},h=(0,i.Ue)((e,t)=>({logicalClock:0,initNodes:u,initEdges:p,nodes:[...u],edges:[...p],onNodesChange:n=>{e({nodes:(0,o.Fb)(n,t().nodes)})},onEdgesChange:n=>{e({edges:(0,o.yn)(n,t().edges)})},onConnect:n=>{e({edges:(0,o.Z_)(n,t().edges)})},createNodes(n){e({nodes:[...t().nodes,...n]})},createEdges(n){e({edges:[...t().edges,...n]})},resetFlow(){e({nodes:u,edges:p})},availableModels:[],getAvailableModels(){fetch("/api/models/getModels").then(e=>e.json()).then(t=>{e({availableModels:t})})},modelInputText:[""],modelInputSubWords:[["This","is","an","ex","amp","le"]],modelInputTokens:[[1,2,3,4,5]],updateModelInputText(t){e({modelInputText:[t]}),fetch("/api/tokenize/toTokens",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:[t]})}).then(e=>e.json()).then(t=>{e({modelInputTokens:t.tokens})}),fetch("/api/tokenize/toStringTokens",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:[t]})}).then(e=>e.json()).then(t=>{e({modelInputSubWords:t.stringTokens})})},updatemodelInputTokens(t){e({modelInputTokens:t})},modelActivations:{},inferencePrompt:"",inferenceSubWords:[],inferencing:!1,modelOutputlogits:[],modelOutputTokens:[],modelOutputSubWords:[],modelOutputLoss:[],modelOuputFinalLoss:0,inferenceModel(){e({inferencing:!0}),fetch("/api/inference/run").then(e=>e.json()).then(t=>{console.log(t),e({inferencePrompt:t.inferencePrompt,inferenceSubWords:t.inferenceSubWords,modelOutputlogits:t.logits,modelOutputTokens:t.tokens,modelOutputSubWords:t.subWords,modelOutputLoss:t.tokenLoss,modelOuputFinalLoss:t.finalLoss,modelActivations:Object.fromEntries(Object.entries(t.activationData).map(e=>{let[t,n]=e;return[t,c.XeE(n)]}))}),e({inferencing:!1})})},modelAblations:{},syncAblations(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t().logicalClock,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};fetch("/api/ablation/sync",{...x,body:JSON.stringify({ablations:a,clientLogicalClock:n})}).then(e=>e.json()).then(t=>{e(e=>({modelAblations:{...t.ablations},logicalClock:Math.max(n,t.server_logical_clock)+1}))})},addAblations(e,n,a){let{modelAblations:l,logicalClock:o}=t(),s={...l,[e]:{...null==l?void 0:l[e],...Object.assign({},...n.map(e=>({[e]:{slice:e,ablationType:a}})).values())}};t().syncAblations(o,s)},rmAblations(e,n){let{modelAblations:a,logicalClock:l}=t(),o=n.reduce((t,n)=>({...t,[e]:{...m(n,null==t?void 0:t[e])}}),{...a});t().syncAblations(l,o)}}));var g=n(20563);let f=e=>({updatemodelInputTokens:e.updatemodelInputTokens,modelInputTokens:e.modelInputTokens,modelInputSubWords:e.modelInputSubWords,modelInputText:e.modelInputText,modelActivations:e.modelActivations,inferencePrompt:e.inferencePrompt}),y=e=>{let{data:t}=e,n=h(f,d.X);return(0,a.jsxs)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("div",{className:"flex",children:(0,a.jsx)("div",{className:"flex flex-row w-[48em]",children:(0,a.jsxs)("span",{className:"block text-xs text-slate-400 py-2",children:["[",n.modelInputTokens[0].map((e,t)=>(0,a.jsxs)("span",{className:"px-px",children:[String(e),", "]},t)),"]"]})})}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-16 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-16 !bg-teal-500"})]})},b=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,n=e*(360/t)%360;return g.USs("hsla(".concat(n,", 1%, 0%, 0.0)"),"hsla(".concat(n,", 100%, 60%, 1.0)"))},v=(e,t)=>Array.from({length:e},(e,n)=>g.cJy().interpolator(b(n)).domain(t));function j(e){let t=/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.e-]+))?\)/.exec(e);if(!t)return;let[,n,a,l,o]=t;return{r:parseInt(n),g:parseInt(a),b:parseInt(l),a:o?parseFloat(o):1}}let w=(e,t,n,a)=>{if(!e)return function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return""};let l=null==e?void 0:e.transpose([0,1,3,2]),[o,s,r,d]=l.shape,i=l.mean(0);console.log("rerender");let u=-1===t?i:c.L9e(c.tPi(i,[t,0,0],[1,r,d]),[0]),p=[u.min().dataSync()[0],u.max().dataSync()[0]],m=i.arraySync(),x=i.transpose([0,2,1]).arraySync(),h=v(s,p);return(e,t)=>{let l="Key → Query"===a?m:x,o=null!==n?n:e,s=-1===t?h.map((t,n)=>t(l[n][e][o])):[h[t](l[t][e][o])];return function(e){let[t,n,a,l]=e;return"rgba(".concat(t,", ").concat(n,", ").concat(a,", ").concat(l,")")}(function(e){let[t,n,a,l]=[0,0,0,0];return e.map(j).forEach(e=>{let{r:o,g:s,b:r,a:d}=e,i=1-d;t=o*d+t*i,n=s*d+n*i,a=r*d+a*i,l=d+i*(1-d)}),[t,n,a,l].map(e=>Math.round(e))}(s))}},N=e=>{var t,n,o,s;let{layer:r=1,head:i=-1,direction:c="Key → Query",formatting:u="text"}=e,p=h(f,d.X),[m,x]=(0,l.useState)(null),g="blocks.".concat(r,".attn.hook_pattern"),y=null===(t=p.modelActivations)||void 0===t?void 0:null===(n=t[g])||void 0===n?void 0:null===(o=n.shape)||void 0===o?void 0:o[2],b=w(null===(s=p.modelActivations)||void 0===s?void 0:s[g],i,m,c);return(0,a.jsx)("div",{className:"flex",children:(0,a.jsx)("div",{className:"flex flex-row w-[48em]",children:(0,a.jsxs)("span",{className:"block text-xs text-slate-400 py-2",children:["array"===u&&"[",p.modelInputSubWords[0].map((e,t)=>(0,a.jsxs)("span",{id:"word-".concat(t),className:"px-px",style:{backgroundColor:p.inferencePrompt[0]===p.modelInputText[0]&&y===p.modelInputSubWords[0].length?b(t,i):""},onMouseOver:()=>x(t),onMouseOut:()=>x(null),children:[e,"array"===u&&","]},t)),"array"===u&&"]"]})})})},I=e=>{let{data:t}=e;return(0,a.jsxs)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)(N,{layer:1,head:-1,direction:"Key → Query",formatting:"array"}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-16 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-16 !bg-teal-500"})]})},k=e=>({modelInputText:e.modelInputText,updateModelInputText:e.updateModelInputText,inferencing:e.inferencing,inferenceModel:e.inferenceModel}),S=()=>{let e=h(k,d.X);return(0,a.jsxs)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("div",{className:"flex",children:(0,a.jsx)("div",{className:"flex flex-row",children:(0,a.jsx)("label",{className:"w-[48em] block",children:(0,a.jsx)("input",{className:"text-slate-300 bg-slate-900 shadow-sm border-0 focus:outline-none focus:border-0 placeholder-slate-400 text-sm py-2 px-3 w-full ",placeholder:"Example input...",value:e.modelInputText,onChange:t=>e.updateModelInputText(t.target.value)})})})}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-16 !bg-teal-500"})]})},A=e=>{let{layerCount:t=5,headCount:n=5}=e,o=h(k,d.X),[s,r]=(0,l.useState)("2"),[i,c]=(0,l.useState)("2"),[u,p]=(0,l.useState)("Key → Query"),m=Array.from({length:t},(e,t)=>(0,a.jsx)("option",{value:t,children:"Layer ".concat(t)},t)),x=[{value:"-1",text:"All"},...Array.from({length:n},(e,t)=>({value:t,text:"Head ".concat(t)}))].map(e=>{let{value:t,text:n}=e;return(0,a.jsx)("option",{value:t,children:n},t)}),g=()=>{p(e=>"Key → Query"===e?"Key ← Query":"Key → Query")};return(0,a.jsx)("div",{className:"absolute bottom-6 left-1/2 -translate-x-1/2 z-50 text-slate-400",children:(0,a.jsxs)("div",{className:"flex flex-row",children:[(0,a.jsxs)("div",{className:"flex flex-col px-2 mx-4 py-4 w-[8em] shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("div",{className:"flex flex-row justify-center  px-0 py-1 h-1/3",children:(0,a.jsx)("select",{className:"text-xs bg-slate-900 border-0 focus:ring-0 focus:outline-none focus:border-0 ",value:s,onChange:e=>{r(e.target.value)},children:m})}),(0,a.jsx)("div",{className:"flex flex-row justify-center px-0 py-1 h-1/3",children:(0,a.jsx)("select",{className:"text-xs  bg-slate-900 border-0 focus:ring-0 focus:outline-none focus:border-0 ",value:i,onChange:e=>{c(e.target.value)},children:x})}),(0,a.jsx)("div",{className:"flex flex-row justify-center py-1 h-1/3",children:(0,a.jsx)("button",{className:"text-xs bg-slate-900 border-0 focus:ring-0 focus:outline-none focus:border-0",onClick:g,children:u})})]}),(0,a.jsx)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("div",{className:"flex flex-row px-5 py-1",children:(0,a.jsx)(N,{layer:parseInt(s),head:parseInt(i),direction:u})}),(0,a.jsxs)("div",{className:"flex flex-row relative",children:[(0,a.jsx)("label",{className:"w-[48em] block",children:(0,a.jsx)("input",{className:"bg-slate-900 shadow-sm border-0 focus:outline-none focus:border-0 placeholder-slate-400 text-sm py-2 px-3 w-full ",placeholder:"Example input...",value:o.modelInputText,onChange:e=>o.updateModelInputText(e.target.value)})}),(0,a.jsx)("button",{type:"button",className:"absolute inset-y-0 right-0 pr-3 flex items-center text-green-500",onClick:()=>o.inferenceModel(),disabled:o.inferencing,children:o.inferencing?(0,a.jsx)("svg",{className:"animate-spin h-5 w-5 mr-2",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})}):(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",className:"h-5 w-5 mr-2",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})})]})]})})]})})},T=e=>({modelActivations:e.modelActivations}),L=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,n=e*(360/t)%360;return g.USs("hsla(".concat(n,", 30%, 0%, 0.0)"),"hsla(".concat(n,", 30%, 60%, 1.0)"))},_=e=>{let{data:t,width:n,height:o,renderText:s=!1}=e,r=(0,l.useRef)(null);return(0,l.useEffect)(()=>{if(!r.current)return;let[e,a,l,d]=t.shape,i=t.mean(0),c=[i.min().dataSync()[0],i.max().dataSync()[0]],u=Array.from({length:l},(e,t)=>g.cJy().interpolator(L(t)).domain(c)),p=g.tiA().domain(g.w6H(a).map(String)).range([0,n]).paddingInner(.3),m=g.tiA().domain(g.w6H(d*l).map(String)).range([0,o]),x=i.arraySync(),h=g.Ys(r.current),f=h.node().getContext("2d");if(f){h.attr("width",2*n),h.attr("height",2*o),h.style("width","".concat(n,"px")),h.style("height","".concat(o,"px")),f.scale(2,2),f.clearRect(0,0,n,o);for(let e=0;e<a;e++)for(let t=0;t<l;t++)for(let n=0;n<d;n++)f.fillStyle=u[t](x[e][t][n]),f.fillRect(p(String(e)),m(String(n+t*d)),p.bandwidth(),m.bandwidth());if(s){f.textAlign="center",f.textBaseline="middle",f.fillStyle="rgb(203 213 225)",f.font="".concat(.3*p.bandwidth(),"px sans-serif");for(let e=0;e<a;e++)for(let t=0;t<d;t++)f.fillText(x[e][t].toFixed(2),p(String(e))+p.bandwidth()/2,m(String(t))+m.bandwidth()/2)}}},[t,n,o]),(0,a.jsx)("canvas",{ref:r,width:n,height:o})},H=e=>{var t,n;let{data:l}=e,s=h(T,d.X);return(0,a.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:l.label}),(0,a.jsx)("div",{className:"flex",children:(0,a.jsx)("div",{className:"flex flex-row w-48 h-24",children:(0,a.jsx)(_,{data:null!==(n=null===(t=s.modelActivations)||void 0===t?void 0:t[l.realationId])&&void 0!==n?n:l.kqv,width:192,height:96})})}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-8 !bg-teal-500"})]})},C=e=>({inferenceModel:e.inferenceModel}),O=(e,t,n)=>{n.inferenceModel(),e.stopPropagation()};function M(e){let{id:t,sourceX:n,sourceY:l,targetX:s,targetY:r,sourcePosition:i,targetPosition:c,style:u={},markerEnd:p}=e,m=h(C,d.X),[x,g,f]=(0,o.OQ)({sourceX:n,sourceY:l,sourcePosition:i,targetX:s,targetY:r,targetPosition:c});return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("path",{id:t,style:u,className:"react-flow__edge-path",d:x,markerEnd:p}),(0,a.jsx)("foreignObject",{width:48,height:48,x:g-24,y:f-24,className:"edgebutton-foreignobject w-12 h-12 flex flex-center",requiredExtensions:"http://www.w3.org/1999/xhtml",children:(0,a.jsx)("div",{className:"m-1 h-10 w-10 justify-center items-center flex",children:(0,a.jsx)("button",{className:"edgebutton rounded-full p-2 justify-center bg-slate-800 items-center ring-1 ring-slate-200/20 shadow-lg w-10 h-10",onClick:e=>O(e,t,m),children:(0,a.jsx)("svg",{className:"w-6 h-6 text-green-500 rotate-180",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{d:"M19 14l-7 7m0 0l-7-7m7 7V3"})})})})})]})}let P=e=>{let{data:t}=e;return(0,a.jsxs)("div",{className:"px-2 py-2 w-[12em] shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:t.label}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-8 !bg-teal-500"})]})},E=e=>({modelActivations:e.modelActivations}),R=e=>{let{data:t,width:n,height:o,renderText:s=!1,useCanvas:r=!0}=e,d=(0,l.useRef)(null);return(0,l.useEffect)(()=>{if(!d.current)return;let[e,a,l]=t.shape,r=t.mean(0),i=[r.min().dataSync()[0],r.max().dataSync()[0]],c=g.cJy().interpolator(g.Vaf).domain(i),u=g.tiA().domain(g.w6H(a).map(String)).range([0,n]).paddingInner(.3),p=g.tiA().domain(g.w6H(l).map(String)).range([0,o-5]),m=r.arraySync(),x=g.Ys(d.current),h=x.node().getContext("2d");if(h){x.attr("width",2*n),x.attr("height",2*o),x.style("width","".concat(n,"px")),x.style("height","".concat(o,"px")),h.scale(2,2),h.clearRect(0,0,n,o);for(let e=0;e<a;e++)for(let t=0;t<l;t++)h.fillStyle=c(m[e][t]),h.fillRect(u(String(e)),p(String(t)),u.bandwidth(),p.bandwidth());if(s){h.textAlign="center",h.textBaseline="middle",h.fillStyle="rgb(203 213 225)",h.font="".concat(.3*u.bandwidth(),"px sans-serif");for(let e=0;e<a;e++)for(let t=0;t<l;t++)h.fillText(m[e][t].toFixed(2),u(String(e))+u.bandwidth()/2,p(String(t))+p.bandwidth()/2)}}},[t,n,o]),r?(0,a.jsx)("canvas",{ref:d,width:n,height:o}):(0,a.jsx)("svg",{ref:d,width:n,height:o})},W=e=>{var t,n;let{data:l}=e,s=h(E,d.X);return(0,a.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:l.label}),(0,a.jsx)("div",{className:"flex",children:(0,a.jsx)("div",{className:"flex flex-row w-72 h-72",children:(0,a.jsx)(R,{data:null!==(n=null===(t=s.modelActivations)||void 0===t?void 0:t[l.realationId])&&void 0!==n?n:l.embed,width:288,height:288})})}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-8 !bg-teal-500"})]})},z=e=>{var t,n;let{data:l}=e,s=h(E,d.X);return(0,a.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:"Attention Residual"}),(0,a.jsx)("div",{className:"flex",children:(0,a.jsx)("div",{className:"flex flex-row ",children:(0,a.jsx)(R,{data:null!==(n=null===(t=s.modelActivations)||void 0===t?void 0:t[l.realationId])&&void 0!==n?n:l.residual,width:144,height:144})})}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-8 !bg-teal-500"})]})};var B=n(83300),X=n(85529);let F=e=>({modelActivations:e.modelActivations,modelAblations:e.modelAblations,addAblations:e.addAblations,rmAblations:e.rmAblations}),G=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,n=e*(360/t)%360;return g.USs("hsla(".concat(n,", 1%, 0%, 0.0)"),"hsla(".concat(n,", 100%, 60%, 1.0)"))},J=e=>{let{data:t,width:n,height:o,renderText:s=!1,colourId:r=0,useCanvas:d=!0}=e,i=(0,l.useRef)(null);return(0,l.useEffect)(()=>{let[e,a,l]=t.shape,d=t.mean(0),c=[d.min().dataSync()[0],d.max().dataSync()[0]],u=g.cJy().interpolator(G(r)).domain(c),p=g.tiA().domain(g.w6H(a).map(String)).range([0,n]),m=g.tiA().domain(g.w6H(l).map(String)).range([0,o]),x=d.arraySync();if(!i.current)return;let h=g.Ys(i.current),f=h.node().getContext("2d");if(f){h.attr("width",2*n),h.attr("height",2*o),h.style("width","".concat(n,"px")),h.style("height","".concat(o,"px")),f.scale(2,2),f.clearRect(0,0,n,o);for(let e=0;e<a;e++)for(let t=0;t<l;t++)f.fillStyle=u(x[e][t]),f.fillRect(p(String(e)),m(String(t)),p.bandwidth(),m.bandwidth());if(s){f.textAlign="center",f.textBaseline="middle",f.fillStyle="rgb(203 213 225)",f.font="".concat(.3*p.bandwidth(),"px sans-serif");for(let e=0;e<a;e++)for(let t=0;t<l;t++)f.fillText(x[e][t].toFixed(2),p(String(e))+p.bandwidth()/2,m(String(t))+m.bandwidth()/2)}}},[t,n,o,s,r]),d?(0,a.jsx)("canvas",{ref:i,width:n,height:o}):(0,a.jsx)("svg",{ref:i,width:n,height:o})},Q=e=>{let{data:t,width:n,height:o,useCanvas:s=!0}=e,r=(0,l.useRef)(null);return(0,l.useEffect)(()=>{let[e,a,l,s]=t.shape,d=t.mean(0),i=g.tiA().domain(g.w6H(l).map(String)).range([0,n]),c=g.tiA().domain(g.w6H(s).map(String)).range([0,o]);if(!r.current)return;let u=g.Ys(r.current),p=u.node().getContext("2d");p&&(u.attr("width",2*n),u.attr("height",2*o),u.style("width","".concat(n,"px")),u.style("height","".concat(o,"px")),p.scale(2,2),d.arraySync().forEach((e,t)=>{let n=g.cJy().interpolator(G(t)).domain(g.Wem(e.flat()));for(let t=0;t<l;t++)for(let a=0;a<s;a++)p.fillStyle=n(e[t][a]),p.fillRect(i(String(t)),c(String(a)),i.bandwidth(),c.bandwidth())}))},[t,n,o,s]),s?(0,a.jsx)("canvas",{ref:r,width:n,height:o}):(0,a.jsx)("svg",{ref:r,width:n,height:o})},U=(e,t)=>Array.from({length:t},(e,t)=>[[0,-1],[t,t+1],[0,-1],[0,-1]]).filter(t=>t[1][0]!==e),Z=e=>{var t,n,s,r,i;let{data:u}=e,{modelActivations:p,modelAblations:m,rmAblations:x,addAblations:g}=h(F,d.X);console.log(m);let f=[[0,-1],[null==u?void 0:u.relationSliceId,(null==u?void 0:u.relationSliceId)+1],[0,-1],[0,-1]],y=null!==(r=null==m?void 0:null===(t=m[u.realationId])||void 0===t?void 0:null===(n=t[f.toString()])||void 0===n?void 0:n.slice)&&void 0!==r&&r,[b,v]=(0,l.useState)(!1),j=null!==(i=null==p?void 0:null===(s=p[u.realationId])||void 0===s?void 0:s.transpose([0,1,3,2]))&&void 0!==i?i:u.pattern,w=j.shape;return(0,a.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950 ".concat(y?"grayscale-[95%]":""),onMouseEnter:()=>v(!0),onMouseLeave:()=>v(!1),children:[(0,a.jsx)(B.M,{offset:0,isVisible:b,position:o.Ly.Right,children:(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("button",{className:"bg-slate-800 hover:bg-red-400 text-slate-300 py-2 px-2 rounded-md my-1",onClick:y?()=>x(u.realationId,[f]):()=>g(u.realationId,[f],"zero"),children:(0,a.jsx)("div",{title:"Ablate Head",children:(0,a.jsx)(X.BRS,{fill:y?"#888":"#fff",size:16})})}),(0,a.jsx)("button",{className:"bg-slate-800 hover:bg-red-400 text-slate-300 py-2 px-2 rounded-md my-1",onClick:y?()=>x(u.realationId,U(null==u?void 0:u.relationSliceId,u.pattern.shape[1])):()=>g(u.realationId,U(null==u?void 0:u.relationSliceId,u.pattern.shape[1]),"zero"),children:(0,a.jsx)("div",{title:"Isolate Head",children:(0,a.jsx)(X.Rvi,{size:16})})})]})}),(0,a.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:u.label}),(0,a.jsx)("div",{className:"flex",children:(0,a.jsx)("div",{className:"flex flex-row w-24 h-24",children:"relationSliceId"in u?(0,a.jsx)(J,{data:c.L9e(c.tPi(j,[0,u.relationSliceId,0,0],[w[0],1,w[2],w[3]]),[1]),width:96,height:96,colourId:u.colourId}):(0,a.jsx)(Q,{data:j,width:96,height:96})})}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-8 !bg-teal-500"})]})},q=e=>{var t,n,l;let{data:s}=e,r=h(F,d.X);return(0,a.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:s.label}),(0,a.jsx)("div",{className:"flex",children:(0,a.jsx)("div",{className:"flex flex-row w-24 h-24",children:(0,a.jsx)(Q,{data:null!==(l=null===(t=r.modelActivations)||void 0===t?void 0:null===(n=t[s.realationId])||void 0===n?void 0:n.transpose([0,2,1,3]))&&void 0!==l?l:s.result,width:96,height:96})})}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-8 !bg-teal-500"})]})};var K=n(23838),V=n(13045);n(84249);let Y=e=>({modelOutputlogits:e.modelOutputlogits,modelOutputTokens:e.modelOutputTokens,modelOutputSubWords:e.modelOutputSubWords,modelOutputLoss:e.modelOutputLoss,inferenceSubWords:e.inferenceSubWords}),D=e=>{let{data:t}=e,{modelOutputSubWords:n,modelOutputLoss:s,inferenceSubWords:r}=h(Y,d.X),[i,c]=(0,l.useState)(null),u=(0,l.useRef)(null);return(0,l.useEffect)(()=>{if(!u.current)return;(0,K.Z)(u.current).selectAll("*").remove();let e=(0,V.Z)().domain([0,s.length]).range([10,566]),t=(0,V.Z)().domain([0,Math.max(...s)]).range([96,0]),n=(0,K.Z)(u.current).attr("width",576).attr("height",96),a=n.selectAll("rect").data(s).join("rect");a.attr("x",(t,n)=>e(n)).attr("y",e=>t(e)).attr("width",576/s.length-8).attr("height",e=>96-t(e)).attr("fill",(e,t)=>t===i?"#d73027":"rgba(214, 39, 40, 0.2)"),a.on("mouseover",(e,t)=>c(t)).on("mouseout",()=>c(null)).append("title").text(e=>"Loss: ".concat(e));let l=n.selectAll("line").data(s).join("line");l.attr("x1",(t,n)=>e(n)).attr("y1",e=>t(e)).attr("x2",(t,n)=>e(n)+576/s.length-8).attr("y2",e=>t(e)).attr("stroke",(e,t)=>t===i?"#d73027":"rgba(214, 39, 40, 0.2)").attr("stroke-width",2)},[s,i]),(0,l.useEffect)(()=>{if(u.current){let e=(0,K.Z)(u.current);e.selectAll("rect").attr("fill",(e,t)=>t===i?"#d73027":"rgba(214, 39, 40, 0.2)"),e.selectAll("line").attr("stroke",(e,t)=>t===i?"#d73027":"rgba(214, 39, 40, 0.2)")}},[i]),console.log("modelOutputSubWords"),console.log(n),(0,a.jsxs)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("div",{className:"py-2",children:(0,a.jsx)("svg",{ref:u})}),(0,a.jsx)("div",{className:"flex flex-wrap w-[576px] py-2",children:n.length>0&&n[0].map((e,t)=>(0,a.jsxs)("div",{className:"px-1",children:[(0,a.jsx)("span",{id:"word-".concat(t),className:"text-xs ".concat(i===t?"text-red-500":"text-slate-600"),children:t+1<r[0].length&&r[0][t+1]}),(0,a.jsx)("br",{}),(0,a.jsx)("span",{className:"text-sm ".concat(i===t?"text-red-500":"text-slate-300"),onMouseOver:()=>c(t),onMouseOut:()=>c(null),children:e})]},t))}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-16 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-16 !bg-teal-500"})]})};var $=n(59734);let ee=e=>{let{data:t}=e;return(0,a.jsxs)("div",{className:"px-2 py-2 w-[12em] shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,a.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:t.label}),(0,a.jsx)(o.HH,{type:"target",position:o.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,a.jsx)(o.HH,{type:"source",position:o.Ly.Top,className:"w-8 !bg-teal-500"})]})},et=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return fetch(...t).then(e=>e.json())},en=(e,t)=>({id:"".concat(e,"-").concat(t),source:e,target:t}),ea=(e,t)=>{let n="blocks.".concat(e),a="blocks.".concat(e-1);return{layerId:n,prevLayerResidualId:t?"".concat(a,".hook_resid_mid"):"".concat(a,".hook_resid_post"),attnLayerNormNodeId:"".concat(n,".ln1"),patternId:"".concat(n,".pattern"),resultId:"".concat(n,".result"),residualId:"".concat(n,".hook_resid_mid"),mlpLayerNormId:"".concat(n,".ln2"),mlpId:"".concat(n,".mlp"),mlpResidualId:"".concat(n,".hook_resid_post"),modelOutputId:"output"}},el=e=>({xOffset:120,layerPadding:500,layerInternalPadding:20,layerWidth:40+120*e.n_heads,layerHeight:900,xStartOffset:-400}),eo=(e,t,n)=>{let{layerId:a}=t,{layerWidth:l,xStartOffset:s,layerHeight:r,layerPadding:d}=n;return{id:a,data:{label:"Layer ".concat(e+1)},position:{x:-l+s,y:-(e+1)*(r+d)},sourcePosition:o.Ly.Top,targetPosition:o.Ly.Bottom,style:{width:l,height:r,backgroundColor:"rgba(255, 0, 128, 0.05)",textAlign:"left",fontSize:"32px",padding:"24px",color:"#e2e8f080"}}},es=(e,t)=>{let{layerId:n,attnLayerNormNodeId:a}=e,{layerWidth:l}=t;return{id:a,type:"layerNorm",data:{label:"Layer Norm"},position:{x:l/2-50,y:850},sourcePosition:o.Ly.Top,targetPosition:o.Ly.Bottom,parentNode:n,extent:"parent"}},er=(e,t,n,a,l)=>{let{layerId:o}=a,{layerInternalPadding:s}=l;return{id:"".concat(o,".").concat(e),type:e,data:{label:"".concat(e),realationId:"".concat(o,".attn.hook_").concat(e[0]),kqv:c.nGf([1,5,n,5])},position:{x:20+400*t,y:s+("value"===e?200:700)},parentNode:o,extent:"parent"}},ed=(e,t,n,a)=>{let{layerId:l,patternId:o}=t,{layerInternalPadding:s}=n;return{id:o,type:"pattern",data:{label:"Pattern",layerNumber:a,realationId:"".concat(l,".attn.hook_pattern"),colourId:0,pattern:c.nGf([1,e,5,5])},position:{x:600,y:200+s},parentNode:l,extent:"parent"}},ei=(e,t,n,a)=>{let{layerId:l}=t,{xOffset:o,layerInternalPadding:s}=n;return Array.from({length:e},(t,n)=>{let r="".concat(l,".headPattern").concat(n);return{id:r,type:"headPattern",data:{label:"Head ".concat(n),layerNumber:a,realationId:"".concat(l,".attn.hook_pattern"),relationSliceId:n,colourId:n,pattern:c.nGf([1,e,5,5])},position:{x:20+n*o,y:400+s},parentNode:l,extent:"parent"}})},ec=(e,t,n)=>{let{layerId:a,resultId:l}=t,{layerInternalPadding:o}=n;return{id:l,type:"result",data:{label:"Result",realationId:"".concat(a,".attn.hook_z"),result:c.nGf([1,e,5,5])},position:{x:600,y:o},parentNode:a,extent:"parent"}},eu=(e,t,n)=>{let{layerId:a,residualId:l}=e,{layerHeight:o,layerPadding:s}=t;return{id:l,type:"residual",data:{label:"Residual",realationId:"".concat(a,".hook_resid_mid"),residual:c.nGf([1,5,5])},position:{x:0,y:-o-s-n*(o+s)-200}}},ep=(e,t,n)=>{let{mlpId:a}=e,{xStartOffset:l,layerHeight:o,layerPadding:s,layerWidth:r}=t;return{id:a,type:"mlp",data:{label:"MLP"},position:{x:-r/2.5,y:-(n+1)*(o+s)-320}}},em=(e,t,n)=>{let{mlpLayerNormId:a}=e,{xStartOffset:l,layerHeight:o,layerPadding:s,layerWidth:r}=t;return{id:a,type:"layerNorm",data:{label:"Layer Norm"},position:{x:-r/2.5,y:-(n+1)*(o+s)-220}}},ex=(e,t,n)=>{let{layerId:a,mlpResidualId:l}=e,{layerHeight:o,layerPadding:s}=t;return{id:l,type:"residual",data:{label:"Residual",realationId:"".concat(a,".hook_resid_post"),residual:c.nGf([1,5,5])},position:{x:0,y:-o-s-n*(o+s)-500}}},eh=(e,t,n)=>{let{modelOutputId:a}=e,{layerHeight:l,layerPadding:o}=t;return{id:a,type:"modelOutput",data:{label:"Output"},position:{x:-200,y:-l-o-n*(l+o)-500-300}}},eg=e=>{let t=el(e);var n=[],a=[];for(let l=0;l<e.n_layers;l++){let o=ea(l,e.attn_only);n=[...n,eo(l,o,t),es(o,t),...["query","key","value"].map((n,a)=>er(n,a,e.n_heads,o,t)),ed(e.n_heads,o,t,l),...ei(e.n_heads,o,t,l),ec(e.n_heads,o,t),eu(o,t,l),...e.attn_only?[]:[em(o,t,l),ep(o,t,l),ex(o,t,l)],...l===e.n_layers-1?[eh(o,t,l)]:[]],a=[...a,...l>0?[en(o.prevLayerResidualId,o.layerId)]:[],...["query","key"].flatMap(t=>Array.from({length:e.n_heads},(e,n)=>en("".concat(o.layerId,".").concat(t),"".concat(o.layerId,".headPattern").concat(n)))),...["query","key","value"].map(e=>en(o.attnLayerNormNodeId,"".concat(o.layerId,".").concat(e))),...Array.from({length:e.n_heads},(e,t)=>en("".concat(o.layerId,".headPattern").concat(t),o.patternId)),en(o.patternId,o.resultId),en("".concat(o.layerId,".value"),o.resultId),en(o.resultId,o.residualId),en(o.prevLayerResidualId,o.residualId),...e.attn_only?[]:[en(o.residualId,o.mlpResidualId),en(o.residualId,o.mlpLayerNormId),en(o.mlpLayerNormId,o.mlpId),en(o.mlpId,o.mlpResidualId)],...l===e.n_layers-1?[en(o.mlpResidualId,o.modelOutputId)]:[]]}return[n,a]},ef=e=>({nodes:e.nodes,edges:e.edges,onNodesChange:e.onNodesChange,onEdgesChange:e.onEdgesChange,onConnect:e.onConnect,createNodes:e.createNodes,createEdges:e.createEdges,resetFlow:e.resetFlow}),ey=e=>{let{modelConfig:t}=e,{nodes:n,edges:i,onNodesChange:c,onEdgesChange:u,onConnect:p,createNodes:m,createEdges:x,resetFlow:g}=h(ef,d.X),f=(0,l.useMemo)(()=>({button:M,default:o.Jd}),[]),b=(0,l.useMemo)(()=>({textInput:S,tokenizedWords:I,token:y,embed:W,key:H,query:H,value:H,headPattern:Z,pattern:Z,result:q,residual:z,layerNorm:P,mlp:ee,modelOutput:D}),[]);return(0,l.useEffect)(()=>{let[e,n]=eg(t);g(),m(e),x(n)},[t]),(0,a.jsx)("div",{style:{width:"100%",height:"100vh"},children:(0,a.jsxs)(o.x$,{nodes:n,edges:i,onNodesChange:c,onEdgesChange:u,onConnect:p,nodeTypes:b,edgeTypes:f,fitView:!0,className:"bg-gray-950",minZoom:.05,proOptions:{hideAttribution:!0},children:[(0,a.jsx)(A,{layerCount:t.n_layers,headCount:t.n_heads}),(0,a.jsx)(s.a,{maskColor:"rgb(2 6 23)",nodeColor:"rgb(4 47 46)",style:{backgroundColor:"#0f172a"}}),(0,a.jsx)(r.A,{variant:r.T.Dots,gap:24,size:1})]})})},eb=e=>({syncAblations:e.syncAblations}),ev=e=>{let{selectedModel:t="gpt2"}=e,{syncAblations:n}=h(eb,d.X),{data:l,error:o}=(0,$.ZP)("/api/models/getModelConfig/".concat(t),et);if(o)return(0,a.jsx)("div",{children:"Failed to load"});if(!l)return(0,a.jsx)("div",{children:"Loading..."});n();let s=l.config;return(0,a.jsx)(ey,{modelConfig:s})},ej=e=>({availableModels:e.availableModels,getAvailableModels:e.getAvailableModels}),ew=e=>{let{onSelect:t}=e,{availableModels:n,getAvailableModels:o}=h(ej,d.X),[s,r]=(0,l.useState)(null);(0,l.useEffect)(()=>{o()},[o]);let i=e=>{r(s===e?null:e)},c=async e=>{try{await fetch("/api/models/setModel",{method:"PUT",headers:{"Content-type":"application/json"},body:JSON.stringify({model_name:e})}),console.log("Selected model: ".concat(e)),t(e)}catch(e){console.error("Failed to select the model:",e)}};return n.length?(0,a.jsx)("div",{className:"p-0 max-h-[90vh] overflow-y-auto rounded-sm text-slate-300",children:n.map((e,t)=>(0,a.jsxs)("div",{className:"text-sm bg-slate-800 m-1 w-[600px]",children:[(0,a.jsxs)("div",{className:"bg-gray-700 p-1 flex justify-between items-center rounded-sm",children:[(0,a.jsxs)("div",{className:"px-0.5",onClick:()=>i(t),style:{cursor:"pointer",display:"flex",alignItems:"center"},children:[(0,a.jsx)("div",{style:{marginRight:"10px"},children:s===t?"-":"+"}),(0,a.jsx)("p",{children:e.model_name})]}),(0,a.jsx)("button",{className:"bg-slate-500/20 text-xs py-1 px-2 rounded-sm",onClick:()=>c(e.model_name),children:"Load"})]}),s===t&&(0,a.jsx)("div",{className:"p-1",children:(0,a.jsx)("table",{children:(0,a.jsx)("tbody",{className:"text-xs",children:Object.entries(e).map((e,t)=>{let[n,l]=e;return(0,a.jsxs)("tr",{children:[(0,a.jsxs)("td",{className:"text-gray-300 pr-2",children:[n,":"]}),(0,a.jsx)("td",{className:"text-gray-200",children:JSON.stringify(l)})]},t)})})})})]},t))}):(0,a.jsx)("div",{children:"Loading..."})},eN=e=>{let{onClose:t}=e;return(0,a.jsx)("div",{className:"z-50 fixed top-0 left-0 w-full h-full bg-black bg-opacity-25 flex items-center",children:(0,a.jsxs)("div",{className:"ml-12 bg-gray-800 rounded-lg relative",children:[(0,a.jsx)("button",{className:"absolute top-[-16px] right-[-8px] text-white text-xl font-semibold",onClick:t,children:"\xd7"}),(0,a.jsx)(ew,{onSelect:t})]})})},eI=e=>{let{onClick:t,selectedModel:n}=e;return(0,a.jsx)("button",{className:"bg-slate-900 shadow-lg outline rounded-md outline-2 outline-slate-200/20 w-10 h-10  font-semibold fixed top-4 left-4",onClick:t,children:(0,a.jsx)("span",{className:"text-xs text-slate-300 font-light",children:n})})};var ek=n(5152),eS=n.n(ek);n(11004);let eA=eS()(()=>Promise.all([n.e(524),n.e(5861)]).then(n.bind(n,65861)),{loadableGenerated:{webpack:()=>[65861]},ssr:!1}),eT=eS()(()=>Promise.all([n.e(524),n.e(5934)]).then(n.bind(n,15934)),{loadableGenerated:{webpack:()=>[15934]},ssr:!1}),eL=eS()(()=>Promise.all([n.e(2440),n.e(8149),n.e(5762),n.e(571),n.e(9794),n.e(8042),n.e(8724)]).then(n.bind(n,84259)),{loadableGenerated:{webpack:()=>[84259]},ssr:!1}),e_=()=>{let[e,t]=(0,l.useState)(!1),[n,o]=(0,l.useState)("gpt2");return(0,a.jsx)("div",{className:"w-[100vw] h-[100vh]",children:(0,a.jsxs)(eA,{children:[(0,a.jsx)(eT,{minSize:200,children:(0,a.jsxs)("div",{children:[(0,a.jsx)(ev,{selectedModel:n}),e&&(0,a.jsx)(eN,{onClose:()=>t(!1)}),(0,a.jsx)(eI,{onClick:()=>t(!0),selectedModel:n})]})}),(0,a.jsx)(eT,{snap:!0,children:(0,a.jsx)(eL,{})})]})})};function eH(){return(0,a.jsx)("main",{className:"bg-gray-950 flex min-h-screen flex-col items-center justify-between ",children:(0,a.jsx)(e_,{})})}},75410:function(){},48628:function(){},31601:function(){},67792:function(){},34977:function(){},75042:function(){}},function(e){e.O(0,[864,904,295,2723,5974,3132,2773,4651,9547,1630,2888,179],function(){return e(e.s=48312)}),_N_E=e.O()}]);