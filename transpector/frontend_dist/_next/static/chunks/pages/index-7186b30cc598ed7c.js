(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5405],{48312:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return a(58722)}])},58722:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return eM}});var n=a(41844),l=a(55784),s=a(69071),o=a(32871),r=a(83599);a(92450);var d=a(76248),i=a(73445),c=a(73073);let u=[{id:"text",type:"textInput",data:{text:"Jane Doe"},position:{x:-200,y:400}},{id:"tokenizedWords",type:"tokenizedWords",data:{tokenizedWords:[["This","is","an","ex","amp","le"]],pattern:c.nGf([1,12,7,7])},position:{x:-200,y:300}},{id:"tokens",type:"token",data:{tokens:[1,2,3,4,5]},position:{x:-200,y:200}},{id:"we",type:"embed",data:{label:"Textual Embedding",realationId:"hook_embed",embed:c.nGf([1,5,5])},position:{x:-200,y:-200}},{id:"pos",type:"embed",data:{label:"Positional Embedding",realationId:"hook_pos_embed",embed:c.nGf([1,5,5])},position:{x:200,y:-200}}],p=[{id:"e1",source:"text",target:"tokenizedWords"},{id:"e2",source:"tokenizedWords",target:"tokens"},{id:"e3",source:"tokens",target:"we",type:"button"},{id:"e4",source:"tokens",target:"pos",type:"button"},{id:"we-b1",source:"we",target:"blocks.0"},{id:"e8",source:"we",target:"blocks.0.hook_resid_mid"},{id:"e9",source:"pos",target:"blocks.0"},{id:"e12",source:"pos",target:"blocks.0.hook_resid_mid"}],m=(e,t)=>{let{[e]:a,...n}=t;return n},x={method:"PUT",headers:{"Content-Type":"application/json"}},h=(0,i.Ue)((e,t)=>({logicalClock:0,initNodes:u,initEdges:p,nodes:[...u],edges:[...p],onNodesChange:a=>{e({nodes:(0,s.Fb)(a,t().nodes)})},onEdgesChange:a=>{e({edges:(0,s.yn)(a,t().edges)})},onConnect:a=>{e({edges:(0,s.Z_)(a,t().edges)})},createNodes(a){e({nodes:[...t().nodes,...a]})},createEdges(a){e({edges:[...t().edges,...a]})},resetFlow(){e({nodes:u,edges:p})},availableModels:[],getAvailableModels(){fetch("/api/models/getModels").then(e=>e.json()).then(t=>{e({availableModels:t})})},modelInputText:[""],modelInputSubWords:[["This","is","an","ex","amp","le"]],modelInputTokens:[[1,2,3,4,5]],updateModelInputText(t){e({modelInputText:[t]}),fetch("/api/tokenize/toTokens",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:[t]})}).then(e=>e.json()).then(t=>{e({modelInputTokens:t.tokens})}),fetch("/api/tokenize/toStringTokens",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:[t]})}).then(e=>e.json()).then(t=>{e({modelInputSubWords:t.stringTokens})})},updatemodelInputTokens(t){e({modelInputTokens:t})},modelActivations:{},inferencePrompt:"",inferenceSubWords:[],inferencing:!1,modelOutputlogits:[],modelOutputTokens:[],modelOutputSubWords:[],modelOutputLoss:[],modelOuputFinalLoss:0,inferenceModel(){e({inferencing:!0}),fetch("/api/inference/run").then(e=>e.json()).then(t=>{console.log(t),e({inferencePrompt:t.inferencePrompt,inferenceSubWords:t.inferenceSubWords,modelOutputlogits:t.logits,modelOutputTokens:t.tokens,modelOutputSubWords:t.subWords,modelOutputLoss:t.tokenLoss,modelOuputFinalLoss:t.finalLoss,modelActivations:Object.fromEntries(Object.entries(t.activationData).map(e=>{let[t,a]=e;return[t,c.XeE(a)]}))}),e({inferencing:!1})})},modelAblations:{},syncAblations(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t().logicalClock,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};fetch("/api/ablation/sync",{...x,body:JSON.stringify({ablations:n,clientLogicalClock:a})}).then(e=>e.json()).then(t=>{e(e=>({modelAblations:{...t.ablations},logicalClock:Math.max(a,t.server_logical_clock)+1}))})},addAblations(e,a,n){let{modelAblations:l,logicalClock:s}=t(),o={...l,[e]:{...null==l?void 0:l[e],...Object.assign({},...a.map(e=>({[e]:{slice:e,ablationType:n}})).values())}};t().syncAblations(s,o)},rmAblations(e,a){let{modelAblations:n,logicalClock:l}=t(),s=a.reduce((t,a)=>({...t,[e]:{...m(a,null==t?void 0:t[e])}}),{...n});t().syncAblations(l,s)}}));var g=a(99822);let f=e=>({updatemodelInputTokens:e.updatemodelInputTokens,modelInputTokens:e.modelInputTokens,modelInputSubWords:e.modelInputSubWords,modelInputText:e.modelInputText,modelActivations:e.modelActivations,inferencePrompt:e.inferencePrompt}),y=e=>{let{data:t}=e,a=h(f,d.X);return(0,n.jsxs)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("div",{className:"flex",children:(0,n.jsx)("div",{className:"flex flex-row w-[48em]",children:(0,n.jsxs)("span",{className:"block text-xs text-slate-400 py-2",children:["[",a.modelInputTokens[0].map((e,t)=>(0,n.jsxs)("span",{className:"px-px",children:[String(e),", "]},t)),"]"]})})}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-16 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-16 !bg-teal-500"})]})},b=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,a=e*(360/t)%360;return g.USs("hsla(".concat(a,", 1%, 0%, 0.0)"),"hsla(".concat(a,", 100%, 60%, 1.0)"))},v=(e,t)=>Array.from({length:e},(e,a)=>g.cJy().interpolator(b(a)).domain(t));function j(e){let t=/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.e-]+))?\)/.exec(e);if(!t)return;let[,a,n,l,s]=t;return{r:parseInt(a),g:parseInt(n),b:parseInt(l),a:s?parseFloat(s):1}}let w=(e,t,a,n)=>{if(!e)return function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return""};let l=null==e?void 0:e.transpose([0,1,3,2]),[s,o,r,d]=l.shape,i=l.mean(0),u=-1===t?i:c.L9e(c.tPi(i,[t,0,0],[1,r,d]),[0]),p=[u.min().dataSync()[0],u.max().dataSync()[0]],m=i.arraySync(),x=i.transpose([0,2,1]).arraySync(),h=v(o,p);return(e,t)=>{let l="Key → Query"===n?m:x,s=null!==a?a:e,o=-1===t?h.map((t,a)=>t(l[a][e][s])):[h[t](l[t][e][s])];return function(e){let[t,a,n,l]=e;return"rgba(".concat(t,", ").concat(a,", ").concat(n,", ").concat(l,")")}(function(e){let[t,a,n,l]=[0,0,0,0];return e.map(j).forEach(e=>{let{r:s,g:o,b:r,a:d}=e,i=1-d;t=s*d+t*i,a=o*d+a*i,n=r*d+n*i,l=d+i*(1-d)}),[t,a,n,l].map(e=>Math.round(e))}(o))}},N=e=>{var t,a,s,o;let{layer:r=1,head:i=-1,direction:c="Key → Query",formatting:u="text"}=e,p=h(f,d.X),[m,x]=(0,l.useState)(null),g="blocks.".concat(r,".attn.hook_pattern"),y=null===(t=p.modelActivations)||void 0===t?void 0:null===(a=t[g])||void 0===a?void 0:null===(s=a.shape)||void 0===s?void 0:s[2],b=w(null===(o=p.modelActivations)||void 0===o?void 0:o[g],i,m,c);return(0,n.jsx)("div",{className:"flex",children:(0,n.jsx)("div",{className:"flex flex-row w-[48em]",children:(0,n.jsxs)("span",{className:"block text-xs text-slate-400 py-2",children:["array"===u&&"[",p.modelInputSubWords[0].map((e,t)=>(0,n.jsxs)("span",{id:"word-".concat(t),className:"px-px",style:{backgroundColor:p.inferencePrompt[0]===p.modelInputText[0]&&y===p.modelInputSubWords[0].length?b(t,i):""},onMouseOver:()=>x(t),onMouseOut:()=>x(null),children:[e,"array"===u&&","]},t)),"array"===u&&"]"]})})})},k=e=>{let{data:t}=e;return(0,n.jsxs)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)(N,{layer:1,head:-1,direction:"Key → Query",formatting:"array"}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-16 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-16 !bg-teal-500"})]})},I=e=>({modelInputText:e.modelInputText,updateModelInputText:e.updateModelInputText,inferencing:e.inferencing,inferenceModel:e.inferenceModel}),S=()=>{let e=h(I,d.X);return(0,n.jsxs)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("div",{className:"flex",children:(0,n.jsx)("div",{className:"flex flex-row",children:(0,n.jsx)("label",{className:"w-[48em] block",children:(0,n.jsx)("input",{className:"text-slate-300 bg-slate-900 shadow-sm border-0 focus:outline-none focus:border-0 placeholder-slate-400 text-sm py-2 px-3 w-full ",placeholder:"Example input...",value:e.modelInputText,onChange:t=>e.updateModelInputText(t.target.value)})})})}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-16 !bg-teal-500"})]})},A=e=>{let{layerCount:t=5,headCount:a=5}=e,s=h(I,d.X),[o,r]=(0,l.useState)("2"),[i,c]=(0,l.useState)("2"),[u,p]=(0,l.useState)("Key → Query"),m=Array.from({length:t},(e,t)=>(0,n.jsx)("option",{value:t,children:"Layer ".concat(t)},t)),x=[{value:"-1",text:"All"},...Array.from({length:a},(e,t)=>({value:t,text:"Head ".concat(t)}))].map(e=>{let{value:t,text:a}=e;return(0,n.jsx)("option",{value:t,children:a},t)}),g=()=>{p(e=>"Key → Query"===e?"Key ← Query":"Key → Query")};return(0,n.jsx)("div",{className:"absolute bottom-6 left-1/2 -translate-x-1/2 z-50 text-slate-400",children:(0,n.jsxs)("div",{className:"flex flex-row",children:[(0,n.jsxs)("div",{className:"flex flex-col px-2 mx-4 py-4 w-[8em] shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("div",{className:"flex flex-row justify-center  px-0 py-1 h-1/3",children:(0,n.jsx)("select",{className:"text-xs bg-slate-900 border-0 focus:ring-0 focus:outline-none focus:border-0 ",value:o,onChange:e=>{r(e.target.value)},children:m})}),(0,n.jsx)("div",{className:"flex flex-row justify-center px-0 py-1 h-1/3",children:(0,n.jsx)("select",{className:"text-xs  bg-slate-900 border-0 focus:ring-0 focus:outline-none focus:border-0 ",value:i,onChange:e=>{c(e.target.value)},children:x})}),(0,n.jsx)("div",{className:"flex flex-row justify-center py-1 h-1/3",children:(0,n.jsx)("button",{className:"text-xs bg-slate-900 border-0 focus:ring-0 focus:outline-none focus:border-0",onClick:g,children:u})})]}),(0,n.jsx)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:(0,n.jsxs)("div",{className:"flex flex-col",children:[(0,n.jsx)("div",{className:"flex flex-row px-5 py-1",children:(0,n.jsx)(N,{layer:parseInt(o),head:parseInt(i),direction:u})}),(0,n.jsxs)("div",{className:"flex flex-row relative",children:[(0,n.jsx)("label",{className:"w-[48em] block",children:(0,n.jsx)("input",{className:"bg-slate-900 shadow-sm border-0 focus:outline-none focus:border-0 placeholder-slate-400 text-sm py-2 px-3 w-full ",placeholder:"Example input...",value:s.modelInputText,onChange:e=>s.updateModelInputText(e.target.value)})}),(0,n.jsx)("button",{type:"button",className:"absolute inset-y-0 right-0 pr-3 flex items-center text-green-500",onClick:()=>s.inferenceModel(),disabled:s.inferencing,children:s.inferencing?(0,n.jsx)("svg",{className:"animate-spin h-5 w-5 mr-2",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})}):(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",className:"h-5 w-5 mr-2",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})})]})]})})]})})},T=e=>({modelActivations:e.modelActivations}),L=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,a=e*(360/t)%360;return g.USs("hsla(".concat(a,", 30%, 0%, 0.0)"),"hsla(".concat(a,", 30%, 60%, 1.0)"))},H=e=>{let{data:t,width:a,height:s,renderText:o=!1}=e,r=(0,l.useRef)(null);return(0,l.useEffect)(()=>{if(!r.current)return;let[e,n,l,d]=t.shape,i=t.mean(0),c=[i.min().dataSync()[0],i.max().dataSync()[0]],u=Array.from({length:l},(e,t)=>g.cJy().interpolator(L(t)).domain(c)),p=g.tiA().domain(g.w6H(n).map(String)).range([0,a]).paddingInner(.3),m=g.tiA().domain(g.w6H(d*l).map(String)).range([0,s]),x=i.arraySync(),h=g.Ys(r.current),f=h.node().getContext("2d");if(f){h.attr("width",2*a),h.attr("height",2*s),h.style("width","".concat(a,"px")),h.style("height","".concat(s,"px")),f.scale(2,2),f.clearRect(0,0,a,s);for(let e=0;e<n;e++)for(let t=0;t<l;t++)for(let a=0;a<d;a++)f.fillStyle=u[t](x[e][t][a]),f.fillRect(p(String(e)),m(String(a+t*d)),p.bandwidth(),m.bandwidth());if(o){f.textAlign="center",f.textBaseline="middle",f.fillStyle="rgb(203 213 225)",f.font="".concat(.3*p.bandwidth(),"px sans-serif");for(let e=0;e<n;e++)for(let t=0;t<d;t++)f.fillText(x[e][t].toFixed(2),p(String(e))+p.bandwidth()/2,m(String(t))+m.bandwidth()/2)}}},[t,a,s]),(0,n.jsx)("canvas",{ref:r,width:a,height:s})},_=e=>{var t,a;let{data:l}=e,o=h(T,d.X);return(0,n.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:l.label}),(0,n.jsx)("div",{className:"flex",children:(0,n.jsx)("div",{className:"flex flex-row w-48 h-24",children:(0,n.jsx)(H,{data:null!==(a=null===(t=o.modelActivations)||void 0===t?void 0:t[l.realationId])&&void 0!==a?a:l.kqv,width:192,height:96})})}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-8 !bg-teal-500"})]})},C=e=>({inferenceModel:e.inferenceModel}),M=(e,t,a)=>{a.inferenceModel(),e.stopPropagation()};function O(e){let{id:t,sourceX:a,sourceY:l,targetX:o,targetY:r,sourcePosition:i,targetPosition:c,style:u={},markerEnd:p}=e,m=h(C,d.X),[x,g,f]=(0,s.OQ)({sourceX:a,sourceY:l,sourcePosition:i,targetX:o,targetY:r,targetPosition:c});return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("path",{id:t,style:u,className:"react-flow__edge-path",d:x,markerEnd:p}),(0,n.jsx)("foreignObject",{width:48,height:48,x:g-24,y:f-24,className:"edgebutton-foreignobject w-12 h-12 flex flex-center",requiredExtensions:"http://www.w3.org/1999/xhtml",children:(0,n.jsx)("div",{className:"m-1 h-10 w-10 justify-center items-center flex",children:(0,n.jsx)("button",{className:"edgebutton rounded-full p-2 justify-center bg-slate-800 items-center ring-1 ring-slate-200/20 shadow-lg w-10 h-10",onClick:e=>M(e,t,m),children:(0,n.jsx)("svg",{className:"w-6 h-6 text-green-500 rotate-180",fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{d:"M19 14l-7 7m0 0l-7-7m7 7V3"})})})})})]})}let P=e=>{let{data:t}=e;return(0,n.jsxs)("div",{className:"px-2 py-2 w-[12em] shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:t.label}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-8 !bg-teal-500"})]})},E=e=>({modelActivations:e.modelActivations}),z=e=>{let{data:t,width:a,height:s,renderText:o=!1,useCanvas:r=!0}=e,d=(0,l.useRef)(null);return(0,l.useEffect)(()=>{if(!d.current)return;let[e,n,l]=t.shape,r=t.mean(0),i=[r.min().dataSync()[0],r.max().dataSync()[0]],c=g.cJy().interpolator(g.Vaf).domain(i),u=g.tiA().domain(g.w6H(n).map(String)).range([0,a]).paddingInner(.3),p=g.tiA().domain(g.w6H(l).map(String)).range([0,s-5]),m=r.arraySync(),x=g.Ys(d.current),h=x.node().getContext("2d");if(h){x.attr("width",2*a),x.attr("height",2*s),x.style("width","".concat(a,"px")),x.style("height","".concat(s,"px")),h.scale(2,2),h.clearRect(0,0,a,s);for(let e=0;e<n;e++)for(let t=0;t<l;t++)h.fillStyle=c(m[e][t]),h.fillRect(u(String(e)),p(String(t)),u.bandwidth(),p.bandwidth());if(o){h.textAlign="center",h.textBaseline="middle",h.fillStyle="rgb(203 213 225)",h.font="".concat(.3*u.bandwidth(),"px sans-serif");for(let e=0;e<n;e++)for(let t=0;t<l;t++)h.fillText(m[e][t].toFixed(2),u(String(e))+u.bandwidth()/2,p(String(t))+p.bandwidth()/2)}}},[t,a,s]),r?(0,n.jsx)("canvas",{ref:d,width:a,height:s}):(0,n.jsx)("svg",{ref:d,width:a,height:s})},R=e=>{var t,a;let{data:l}=e,o=h(E,d.X);return(0,n.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:l.label}),(0,n.jsx)("div",{className:"flex",children:(0,n.jsx)("div",{className:"flex flex-row w-72 h-72",children:(0,n.jsx)(z,{data:null!==(a=null===(t=o.modelActivations)||void 0===t?void 0:t[l.realationId])&&void 0!==a?a:l.embed,width:288,height:288})})}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-8 !bg-teal-500"})]})},W=e=>{var t,a;let{data:l}=e,o=h(E,d.X);return(0,n.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:"Attention Residual"}),(0,n.jsx)("div",{className:"flex",children:(0,n.jsx)("div",{className:"flex flex-row ",children:(0,n.jsx)(z,{data:null!==(a=null===(t=o.modelActivations)||void 0===t?void 0:t[l.realationId])&&void 0!==a?a:l.residual,width:144,height:144})})}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-8 !bg-teal-500"})]})};var B=a(83300),X=a(34710),F=a(85529);let G=e=>({modelActivations:e.modelActivations,modelAblations:e.modelAblations,addAblations:e.addAblations,rmAblations:e.rmAblations}),J=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,a=e*(360/t)%360;return g.USs("hsla(".concat(a,", 1%, 0%, 0.0)"),"hsla(".concat(a,", 100%, 60%, 1.0)"))},Q=(e,t)=>{let a=(0,l.useRef)(e.id),n=e.shape,[s,o]=(0,l.useState)(()=>void 0!==t?c.L9e(c.tPi(e.transpose([0,1,3,2]),[0,t,0,0],[n[0],1,n[3],n[2]]),[1]):e.transpose([0,1,3,2])),[r,d]=(0,l.useState)(()=>s.mean(0)),[i,u]=(0,l.useState)(()=>[r.min().dataSync()[0],r.max().dataSync()[0]]),[p,m]=(0,l.useState)(()=>r.arraySync());return(0,l.useEffect)(()=>{if(a.current!==e.id){console.log("data id missmatch",a.current,e.id),a.current=e.id;let n=e.shape,l=void 0!==t?c.L9e(c.tPi(e.transpose([0,1,3,2]),[0,t,0,0],[n[0],1,n[3],n[2]]),[1]):e.transpose([0,1,3,2]),s=l.mean(0);o(l),d(s),u([s.min().dataSync()[0],s.max().dataSync()[0]]),m(s.arraySync())}},[e,t]),{data:s,meanData:r,minMax:i,syncData:p}},q=e=>{let{patternData:t,width:a,height:s,renderText:o=!1,colourId:r=0}=e,d=(0,l.useRef)(null),{data:i,minMax:c,syncData:u}=t,[p,m,x]=i.shape;return(0,l.useEffect)(()=>{if(!d.current)return;let e=g.cJy().interpolator(J(r)).domain(c),t=g.tiA().domain(g.w6H(m).map(String)).range([0,a]),n=g.tiA().domain(g.w6H(x).map(String)).range([0,s]),l=g.Ys(d.current),i=l.node().getContext("2d");if(i){l.attr("width",2*a),l.attr("height",2*s),l.style("width","".concat(a,"px")),l.style("height","".concat(s,"px")),i.scale(2,2),i.clearRect(0,0,a,s);for(let a=0;a<m;a++)for(let l=0;l<x;l++)i.fillStyle=e(u[a][l]),i.fillRect(t(String(a)),n(String(l)),t.bandwidth(),n.bandwidth());if(o){i.textAlign="center",i.textBaseline="middle",i.fillStyle="rgb(203 213 225)",i.font="".concat(.3*t.bandwidth(),"px sans-serif");for(let e=0;e<m;e++)for(let a=0;a<x;a++)i.fillText(u[e][a].toFixed(2),t(String(e))+t.bandwidth()/2,n(String(a))+n.bandwidth()/2)}}},[x,m,c,u,a,s,o,r]),(0,n.jsx)("canvas",{ref:d,width:a,height:s})},U=e=>{let{patternData:t,width:a,height:s,useCanvas:o=!0}=e,r=(0,l.useRef)(null),{data:d,syncData:i}=t,[c,u,p,m]=d.shape;return(0,l.useEffect)(()=>{let e=g.tiA().domain(g.w6H(p).map(String)).range([0,a]),t=g.tiA().domain(g.w6H(m).map(String)).range([0,s]);if(!r.current)return;let n=g.Ys(r.current),l=n.node().getContext("2d");l&&(n.attr("width",2*a),n.attr("height",2*s),n.style("width","".concat(a,"px")),n.style("height","".concat(s,"px")),l.scale(2,2),i.forEach((a,n)=>{let s=g.cJy().interpolator(J(n)).domain(g.Wem(a.flat()));for(let n=0;n<p;n++)for(let o=0;o<m;o++)l.fillStyle=s(a[n][o]),l.fillRect(e(String(n)),t(String(o)),e.bandwidth(),t.bandwidth())}))},[i,m,p,a,s,o]),o?(0,n.jsx)("canvas",{ref:r,width:a,height:s}):(0,n.jsx)("svg",{ref:r,width:a,height:s})},Z=(e,t)=>Array.from({length:t},(e,t)=>[[0,-1],[t,t+1],[0,-1],[0,-1]]).filter(t=>t[1][0]!==e),K=e=>{var t,a,o,r,i,c;let{data:u,selected:p}=e,{modelActivations:m,modelAblations:x,rmAblations:g,addAblations:f}=h(G,d.X),y=[[0,-1],[null==u?void 0:u.relationSliceId,(null==u?void 0:u.relationSliceId)+1],[0,-1],[0,-1]],b=null!==(i=null==x?void 0:null===(t=x[u.realationId])||void 0===t?void 0:null===(a=t[y.toString()])||void 0===a?void 0:a.slice)&&void 0!==i&&i,v=null==x?void 0:null===(o=x[u.realationId])||void 0===o?void 0:null===(r=o[y.toString()])||void 0===r?void 0:r.ablationType,[j,w]=(0,l.useState)(!1),[N,k]=[96,96],[I,S]=(0,l.useState)(N),[A,T]=(0,l.useState)(k),L=Q(null!==(c=null==m?void 0:m[u.realationId])&&void 0!==c?c:u.pattern,null==u?void 0:u.relationSliceId);return(0,n.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950 ".concat(b?"freeze"===v?"grayscale-[25%]":"grayscale-[95%]":""),onMouseEnter:()=>w(!0),onMouseLeave:()=>w(!1),children:[(0,n.jsx)(X.pM,{color:"#ff0071",isVisible:p,minWidth:N,minHeight:k,onResize:(e,t)=>{let{width:a,height:n}=t;S(a),T(n-24)}}),(0,n.jsx)(B.M,{offset:0,isVisible:j,position:s.Ly.Right,children:(0,n.jsxs)("div",{className:"flex flex-col",children:[(0,n.jsx)("button",{className:"bg-slate-800 hover:bg-red-400 text-slate-300 py-2 px-2 rounded-md my-1",onClick:b?()=>g(u.realationId,[y]):()=>f(u.realationId,[y],"zero"),children:(0,n.jsx)("div",{title:"Ablate Head",children:(0,n.jsx)(F.BRS,{fill:"zero"===v?"#888":"#fff",size:16})})}),(0,n.jsx)("button",{className:"bg-slate-800 hover:bg-red-400 text-slate-300 py-2 px-2 rounded-md my-1",onClick:b?()=>g(u.realationId,Z(null==u?void 0:u.relationSliceId,u.pattern.shape[1])):()=>f(u.realationId,Z(null==u?void 0:u.relationSliceId,u.pattern.shape[1]),"zero"),children:(0,n.jsx)("div",{title:"Isolate Head",children:(0,n.jsx)(F.Rvi,{size:16})})}),(0,n.jsx)("button",{className:"bg-slate-800 hover:bg-red-400 text-slate-300 py-2 px-2 rounded-md my-1",onClick:b?()=>g(u.realationId,[y]):()=>f(u.realationId,[y],"freeze"),children:(0,n.jsx)("div",{title:"Freeze Head",children:(0,n.jsx)(F.qQX,{size:16,fill:"freeze"===v?"#888":"#fff"})})})]})}),(0,n.jsxs)("span",{className:"px-2 py-1 text-sm text-slate-300",children:["freeze"===v&&(0,n.jsx)(F.qQX,{size:12})," ",u.label]}),(0,n.jsx)("div",{className:"flex",children:(0,n.jsx)("div",{className:"flex flex-row w-[".concat(I,"px] h-[").concat(A,"px]"),children:"relationSliceId"in u?(0,n.jsx)(q,{patternData:L,width:I,height:A,colourId:u.colourId}):(0,n.jsx)(U,{patternData:L,width:I,height:A})})}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-8 !bg-teal-500"})]})},V=e=>{var t;let{data:a}=e,{modelActivations:l}=h(G,d.X),o=Q(null!==(t=null==l?void 0:l[a.realationId])&&void 0!==t?t:a.result,void 0);return(0,n.jsxs)("div",{className:"px-0 py-0 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:a.label}),(0,n.jsx)("div",{className:"flex",children:(0,n.jsx)("div",{className:"flex flex-row w-24 h-24",children:(0,n.jsx)(U,{patternData:o,width:96,height:96})})}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-8 !bg-teal-500"})]})};var D=a(23838),Y=a(13045);a(84249);let $=e=>({modelOutputlogits:e.modelOutputlogits,modelOutputTokens:e.modelOutputTokens,modelOutputSubWords:e.modelOutputSubWords,modelOutputLoss:e.modelOutputLoss,inferenceSubWords:e.inferenceSubWords}),ee=e=>{let{data:t}=e,{modelOutputSubWords:a,modelOutputLoss:o,inferenceSubWords:r}=h($,d.X),[i,c]=(0,l.useState)(null),u=(0,l.useRef)(null);return(0,l.useEffect)(()=>{if(!u.current)return;(0,D.Z)(u.current).selectAll("*").remove();let e=(0,Y.Z)().domain([0,o.length]).range([25,566]),t=(0,Y.Z)().domain([0,Math.max(...o)]).range([95,4]),a=(0,D.Z)(u.current).attr("width",576).attr("height",96),n=a.selectAll("rect").data(o).join("rect");n.attr("x",(t,a)=>e(a)).attr("y",e=>t(e)).attr("width",576/o.length-4).attr("height",e=>t(0)-t(e)).attr("fill",(e,t)=>t===i?"#d73027":"rgba(214, 39, 40, 0.2)"),n.on("mouseover",(e,t)=>c(t)).on("mouseout",()=>c(null)).append("title").text(e=>"Loss: ".concat(e));let l=a.selectAll("line").data(o).join("line");l.attr("x1",(t,a)=>e(a)).attr("y1",e=>t(e)).attr("x2",(t,a)=>e(a)+576/o.length-4).attr("y2",e=>t(e)).attr("stroke",(e,t)=>t===i?"#d73027":"rgba(214, 39, 40, 0.2)").attr("stroke-width",2);let s=g.y4O(t).ticks(2).tickPadding(4).tickSize(2).tickValues([Math.max(...o)]);a.append("g").attr("transform","translate(20, 0)").style("color","rgba(150,150,150,0.25)").call(s).append("text").attr("class","text-sm").attr("transform","rotate(-90)").attr("y",-15).attr("dy",".71em").attr("x",-64).attr("fill","rgba(150,150,150,0.25)").text("Loss")},[o,i]),(0,l.useEffect)(()=>{if(u.current){let e=(0,D.Z)(u.current);e.selectAll("rect").attr("fill",(e,t)=>t===i?"#d73027":"rgba(214, 39, 40, 0.2)"),e.selectAll("line").attr("stroke",(e,t)=>t===i?"#d73027":"rgba(214, 39, 40, 0.2)")}},[i]),(0,n.jsxs)("div",{className:"px-6 py-4 shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("div",{className:"py-2",children:(0,n.jsx)("svg",{ref:u})}),(0,n.jsx)("div",{className:"flex flex-wrap w-[576px] py-2",children:a.length>0&&a[0].map((e,t)=>(0,n.jsxs)("div",{className:"px-1",children:[(0,n.jsx)("span",{id:"word-".concat(t),className:"text-xs ".concat(i===t?"text-red-500":"text-slate-600"),children:t+1<r[0].length&&r[0][t+1]}),(0,n.jsx)("br",{}),(0,n.jsx)("span",{className:"text-sm ".concat(i===t?"text-red-500":"text-slate-300"),onMouseOver:()=>c(t),onMouseOut:()=>c(null),children:e})]},t))}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-16 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-16 !bg-teal-500"})]})};var et=a(59734);let ea=e=>{let{data:t}=e;return(0,n.jsxs)("div",{className:"px-2 py-2 w-[12em] shadow-md rounded-md bg-slate-900 border-2 border-stone-950",children:[(0,n.jsx)("span",{className:"px-2 py-1 text-sm text-slate-300",children:t.label}),(0,n.jsx)(s.HH,{type:"target",position:s.Ly.Bottom,className:"w-8 !bg-teal-500"}),(0,n.jsx)(s.HH,{type:"source",position:s.Ly.Top,className:"w-8 !bg-teal-500"})]})},en=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return fetch(...t).then(e=>e.json())},el=(e,t)=>({id:"".concat(e,"-").concat(t),source:e,target:t}),es=(e,t)=>{let a="blocks.".concat(e),n="blocks.".concat(e-1);return{layerId:a,prevLayerResidualId:t?"".concat(n,".hook_resid_mid"):"".concat(n,".hook_resid_post"),attnLayerNormNodeId:"".concat(a,".ln1"),patternId:"".concat(a,".pattern"),resultId:"".concat(a,".result"),residualId:"".concat(a,".hook_resid_mid"),mlpLayerNormId:"".concat(a,".ln2"),mlpId:"".concat(a,".mlp"),mlpResidualId:"".concat(a,".hook_resid_post"),modelOutputId:"output"}},eo=e=>({xOffset:120,layerPadding:500,layerInternalPadding:20,layerWidth:40+120*e.n_heads,layerHeight:900,xStartOffset:-400}),er=(e,t,a)=>{let{layerId:n}=t,{layerWidth:l,xStartOffset:o,layerHeight:r,layerPadding:d}=a;return{id:n,data:{label:"Layer ".concat(e)},position:{x:-l+o,y:-(e+1)*(r+d)},sourcePosition:s.Ly.Top,targetPosition:s.Ly.Bottom,style:{width:l,height:r,backgroundColor:"rgba(255, 0, 128, 0.05)",textAlign:"left",fontSize:"32px",padding:"24px",color:"#e2e8f080"}}},ed=(e,t)=>{let{layerId:a,attnLayerNormNodeId:n}=e,{layerWidth:l}=t;return{id:n,type:"layerNorm",data:{label:"Layer Norm"},position:{x:l/2-50,y:850},sourcePosition:s.Ly.Top,targetPosition:s.Ly.Bottom,parentNode:a,extent:"parent"}},ei=(e,t,a,n,l)=>{let{layerId:s}=n,{layerInternalPadding:o}=l;return{id:"".concat(s,".").concat(e),type:e,data:{label:"".concat(e),realationId:"".concat(s,".attn.hook_").concat(e[0]),kqv:c.nGf([1,5,a,5])},position:{x:20+400*t,y:o+("value"===e?200:700)},parentNode:s,extent:"parent"}},ec=(e,t,a,n)=>{let{layerId:l,patternId:s}=t,{layerInternalPadding:o}=a;return{id:s,type:"pattern",data:{label:"Pattern",layerNumber:n,realationId:"".concat(l,".attn.hook_pattern"),colourId:0,pattern:c.nGf([1,e,5,5])},position:{x:600,y:200+o},parentNode:l,extent:"parent"}},eu=(e,t,a,n)=>{let{layerId:l}=t,{xOffset:s,layerInternalPadding:o}=a;return Array.from({length:e},(t,a)=>{let r="".concat(l,".headPattern").concat(a);return{id:r,type:"headPattern",data:{label:"Head ".concat(a),layerNumber:n,realationId:"".concat(l,".attn.hook_pattern"),relationSliceId:a,colourId:a,pattern:c.nGf([1,e,5,5])},position:{x:20+a*s,y:400+o},parentNode:l,extent:"parent"}})},ep=(e,t,a)=>{let{layerId:n,resultId:l}=t,{layerInternalPadding:s}=a;return{id:l,type:"result",data:{label:"Result",realationId:"".concat(n,".attn.hook_z"),result:c.nGf([1,e,5,5])},position:{x:600,y:s},parentNode:n,extent:"parent"}},em=(e,t,a)=>{let{layerId:n,residualId:l}=e,{layerHeight:s,layerPadding:o}=t;return{id:l,type:"residual",data:{label:"Residual",realationId:"".concat(n,".hook_resid_mid"),residual:c.nGf([1,5,5])},position:{x:0,y:-s-o-a*(s+o)-200}}},ex=(e,t,a)=>{let{mlpId:n}=e,{xStartOffset:l,layerHeight:s,layerPadding:o,layerWidth:r}=t;return{id:n,type:"mlp",data:{label:"MLP"},position:{x:-r/2.5,y:-(a+1)*(s+o)-320}}},eh=(e,t,a)=>{let{mlpLayerNormId:n}=e,{xStartOffset:l,layerHeight:s,layerPadding:o,layerWidth:r}=t;return{id:n,type:"layerNorm",data:{label:"Layer Norm"},position:{x:-r/2.5,y:-(a+1)*(s+o)-220}}},eg=(e,t,a)=>{let{layerId:n,mlpResidualId:l}=e,{layerHeight:s,layerPadding:o}=t;return{id:l,type:"residual",data:{label:"Residual",realationId:"".concat(n,".hook_resid_post"),residual:c.nGf([1,5,5])},position:{x:0,y:-s-o-a*(s+o)-500}}},ef=(e,t,a)=>{let{modelOutputId:n}=e,{layerHeight:l,layerPadding:s}=t;return{id:n,type:"modelOutput",data:{label:"Output"},position:{x:-200,y:-l-s-a*(l+s)-500-300}}},ey=e=>{let t=eo(e);var a=[],n=[];for(let l=0;l<e.n_layers;l++){let s=es(l,e.attn_only);a=[...a,er(l,s,t),ed(s,t),...["query","key","value"].map((a,n)=>ei(a,n,e.n_heads,s,t)),ec(e.n_heads,s,t,l),...eu(e.n_heads,s,t,l),ep(e.n_heads,s,t),em(s,t,l),...e.attn_only?[]:[eh(s,t,l),ex(s,t,l),eg(s,t,l)],...l===e.n_layers-1?[ef(s,t,l)]:[]],n=[...n,...l>0?[el(s.prevLayerResidualId,s.layerId)]:[],...["query","key"].flatMap(t=>Array.from({length:e.n_heads},(e,a)=>el("".concat(s.layerId,".").concat(t),"".concat(s.layerId,".headPattern").concat(a)))),...["query","key","value"].map(e=>el(s.attnLayerNormNodeId,"".concat(s.layerId,".").concat(e))),...Array.from({length:e.n_heads},(e,t)=>el("".concat(s.layerId,".headPattern").concat(t),s.patternId)),el(s.patternId,s.resultId),el("".concat(s.layerId,".value"),s.resultId),el(s.resultId,s.residualId),el(s.prevLayerResidualId,s.residualId),...e.attn_only?[]:[el(s.residualId,s.mlpResidualId),el(s.residualId,s.mlpLayerNormId),el(s.mlpLayerNormId,s.mlpId),el(s.mlpId,s.mlpResidualId)],...l===e.n_layers-1?[el(s.mlpResidualId,s.modelOutputId)]:[]]}return[a,n]},eb=e=>({nodes:e.nodes,edges:e.edges,onNodesChange:e.onNodesChange,onEdgesChange:e.onEdgesChange,onConnect:e.onConnect,createNodes:e.createNodes,createEdges:e.createEdges,resetFlow:e.resetFlow}),ev=e=>{let{modelConfig:t}=e,{nodes:a,edges:i,onNodesChange:c,onEdgesChange:u,onConnect:p,createNodes:m,createEdges:x,resetFlow:g}=h(eb,d.X),f=(0,l.useMemo)(()=>({button:O,default:s.Jd}),[]),b=(0,l.useMemo)(()=>({textInput:S,tokenizedWords:k,token:y,embed:R,key:_,query:_,value:_,headPattern:K,pattern:K,result:V,residual:W,layerNorm:P,mlp:ea,modelOutput:ee}),[]);return(0,l.useEffect)(()=>{let[e,a]=ey(t);g(),m(e),x(a)},[t]),(0,n.jsx)("div",{style:{width:"100%",height:"100vh"},children:(0,n.jsxs)(s.x$,{nodes:a,edges:i,onNodesChange:c,onEdgesChange:u,onConnect:p,nodeTypes:b,edgeTypes:f,fitView:!0,className:"bg-gray-950",minZoom:.05,proOptions:{hideAttribution:!0},children:[(0,n.jsx)(o.a,{maskColor:"rgb(2 6 23)",nodeColor:"rgb(4 47 46)",style:{backgroundColor:"#0f172a"}}),(0,n.jsx)(r.A,{variant:r.T.Dots,gap:24,size:1})]})})},ej=e=>({syncAblations:e.syncAblations}),ew=e=>{let{selectedModel:t="gpt2"}=e,{syncAblations:a}=h(ej,d.X),{data:l,error:s}=(0,et.ZP)("/api/models/getModelConfig/".concat(t),en);if(s)return(0,n.jsx)("div",{children:"Failed to load"});if(!l)return(0,n.jsx)("div",{children:"Loading..."});a();let o=l.config;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(ev,{modelConfig:o}),(0,n.jsx)(A,{layerCount:o.n_layers,headCount:o.n_heads})]})},eN=e=>({availableModels:e.availableModels,getAvailableModels:e.getAvailableModels}),ek=e=>{let{onSelect:t}=e,{availableModels:a,getAvailableModels:s}=h(eN,d.X),[o,r]=(0,l.useState)(null);(0,l.useEffect)(()=>{s()},[s]);let i=e=>{r(o===e?null:e)},c=async e=>{try{await fetch("/api/models/setModel",{method:"PUT",headers:{"Content-type":"application/json"},body:JSON.stringify({model_name:e})}),console.log("Selected model: ".concat(e)),t(e)}catch(e){console.error("Failed to select the model:",e)}};return a.length?(0,n.jsx)("div",{className:"p-0 max-h-[90vh] overflow-y-auto rounded-sm text-slate-300",children:a.map((e,t)=>(0,n.jsxs)("div",{className:"text-sm bg-slate-800 m-1 w-[600px]",children:[(0,n.jsxs)("div",{className:"bg-gray-700 p-1 flex justify-between items-center rounded-sm",children:[(0,n.jsxs)("div",{className:"px-0.5",onClick:()=>i(t),style:{cursor:"pointer",display:"flex",alignItems:"center"},children:[(0,n.jsx)("div",{style:{marginRight:"10px"},children:o===t?"-":"+"}),(0,n.jsx)("p",{children:e.model_name})]}),(0,n.jsx)("button",{className:"bg-slate-500/20 text-xs py-1 px-2 rounded-sm",onClick:()=>c(e.model_name),children:"Load"})]}),o===t&&(0,n.jsx)("div",{className:"p-1",children:(0,n.jsx)("table",{children:(0,n.jsx)("tbody",{className:"text-xs",children:Object.entries(e).map((e,t)=>{let[a,l]=e;return(0,n.jsxs)("tr",{children:[(0,n.jsxs)("td",{className:"text-gray-300 pr-2",children:[a,":"]}),(0,n.jsx)("td",{className:"text-gray-200",children:JSON.stringify(l)})]},t)})})})})]},t))}):(0,n.jsx)("div",{children:"Loading..."})},eI=e=>{let{onClose:t,selectedModel:a}=e;return(0,n.jsx)("div",{className:"z-50 fixed top-0 left-0 w-full h-full bg-black bg-opacity-25 flex items-center",children:(0,n.jsxs)("div",{className:"ml-12 bg-gray-800 rounded-lg relative",children:[(0,n.jsx)("button",{className:"absolute top-[-16px] right-[-8px] text-white text-xl font-semibold",onClick:()=>t(a),children:"\xd7"}),(0,n.jsx)(ek,{onSelect:t})]})})},eS=e=>{let{onClick:t,selectedModel:a}=e;return(0,n.jsx)("button",{className:"bg-slate-900 shadow-lg outline rounded-md outline-2 outline-slate-200/20 w-10 h-10 font-semibold fixed top-4 left-4",onClick:t,children:(0,n.jsx)("span",{className:"text-xs text-slate-300 font-light",children:a})})};var eA=a(5152),eT=a.n(eA);a(11004);let eL=eT()(()=>Promise.all([a.e(524),a.e(5861)]).then(a.bind(a,65861)),{loadableGenerated:{webpack:()=>[65861]},ssr:!1}),eH=eT()(()=>Promise.all([a.e(524),a.e(5934)]).then(a.bind(a,15934)),{loadableGenerated:{webpack:()=>[15934]},ssr:!1}),e_=eT()(()=>Promise.all([a.e(2440),a.e(8149),a.e(5762),a.e(571),a.e(9794),a.e(728),a.e(8724)]).then(a.bind(a,84259)),{loadableGenerated:{webpack:()=>[84259]},ssr:!1}),eC=()=>{let[e,t]=(0,l.useState)(!1),[a,s]=(0,l.useState)("gpt2");return(0,n.jsx)("div",{className:"w-[100vw] h-[100vh]",children:(0,n.jsxs)(eL,{children:[(0,n.jsx)(eH,{minSize:200,children:(0,n.jsxs)("div",{children:[(0,n.jsx)(ew,{selectedModel:a}),e&&(0,n.jsx)(eI,{selectedModel:a,onClose:e=>{t(!1),s(null!=e?e:a)}}),(0,n.jsx)(eS,{onClick:()=>t(!0),selectedModel:a})]})}),(0,n.jsx)(eH,{snap:!0,children:(0,n.jsx)(e_,{})})]})})};function eM(){return(0,n.jsx)("main",{className:"bg-gray-950 flex min-h-screen flex-col items-center justify-between ",children:(0,n.jsx)(eC,{})})}},75410:function(){},48628:function(){},31601:function(){},67792:function(){},34977:function(){},75042:function(){}},function(e){e.O(0,[864,904,295,2723,5974,3132,2773,4651,9547,5464,2888,179],function(){return e(e.s=48312)}),_N_E=e.O()}]);